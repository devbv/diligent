# Tech Lead Assessment — 2026-02-27 (8bae17a)

**Scope**: Core package only (incremental improvement review)
**Phase completed**: 4c (Print Mode + Collaboration Modes) + P0/P1 backlog items
**Previous assessment**: 2026-02-27-10f036c (GREEN, Phase 4b)
**Delta**: 14 commits, +1,696 lines in `packages/core/`, 0 deleted files

## Sustainability Verdict

**GREEN — Core remains solid. SessionManager is the one area to watch.**

The 14 commits since last review added collaboration modes, loop detection, env filtering, truncation improvements, and a steering queue — all as clean additive changes. Zero interface breakages, zero layer violations, zero deleted files. 594 tests pass (up from 529). The only structural concern is SessionManager's growing responsibilities, which should be addressed incrementally.

## Structural Integrity

### Decision-Code Alignment: Still Perfect

Spot-checked all new decisions against code:

| Decision | Verdict | Evidence |
|----------|---------|----------|
| D087 (Collaboration modes) | ✅ Match | `agent/types.ts:6-36` — ModeKind type, PLAN_MODE_ALLOWED_TOOLS, MODE_SYSTEM_PROMPT_PREFIXES. `loop.ts:67-79` — mode-based tool filtering and system prompt injection |
| D004 (AgentEvent types) | ✅ Match | `agent/types.ts:48-77` — 20 event types now (15 base + 3 Phase 3b + loop_detected + steering_injected). ARCHITECTURE.md says 15 but actual count is higher — doc is stale |
| D025 (Truncation) | ✅ Match | `tool/truncation.ts` — head_tail mode added with 40/60 split, WARNING marker, byte-aware UTF-8 truncation |

**One stale doc**: ARCHITECTURE.md line 43 says "15 tagged-union event types" but the actual AgentEvent union now has 20 discriminants. Same file line 59 says "18 AgentEvent types" — also stale. The code is correct; only the docs lag.

**Impact**: Cosmetic. But if left indefinitely, creates confusion for future sessions that read ARCHITECTURE.md to orient.

### Layer Boundary Violations: None

Import chain audit for all new code:
- `agent/loop-detector.ts` — zero imports (pure data structure) ✅
- `agent/types.ts` — imports only from `provider/types` and `../types` (base types) ✅
- `session/manager.ts` — imports `agentLoop` from agent and `ProviderError` from provider. This is the one cross-layer import (session→agent, session→provider) but it's structurally required: SessionManager orchestrates agent runs and needs to catch provider errors for reactive compaction. Acceptable.
- `tool/truncation.ts` — zero cross-layer imports, uses only `node:fs/promises` and `node:os` ✅

### Interface Stability: Excellent

All changes since last review were additive:

| Change | Breaking? | Evidence |
|--------|-----------|----------|
| `AgentEvent` +2 variants (loop_detected, steering_injected) | No | Union extension |
| `AgentLoopConfig` +2 optional fields (mode, getSteeringMessages) | No | Optional fields |
| `SessionEntry` +2 variants (ModeChangeEntry, SteeringEntry) | No | Union extension, SESSION_VERSION 3→4 |
| `ToolResult.truncateDirection` gains "head_tail" | No | Additive to existing union |
| `SessionManager` +4 public methods (steer, followUp, hasFollowUp, appendModeChange) | No | New methods only |

### Type Quality

- **`any` count**: Still exactly 1 (`Tool<TParams extends z.ZodType = any>` in tool/types.ts:5)
- **`as` casts**: ~30 instances across core. Categorized:
  - **JSON.parse boundaries** (5): session/persistence.ts, knowledge/store.ts — unavoidable without runtime validation on every line
  - **EventStream `undefined as T`** (4): structural requirement for typed async iterator done signal
  - **Provider SDK bridges** (15): Anthropic/OpenAI SDK types don't exactly match ours — expected at FFI boundary
  - **Generic variance** (3): mergeConfig deep merge, ToolRegistryBuilder — well-contained
  - **Type narrowing after event check** (3): agent loop/manager extractResult — safe, guarded by isComplete

No new `any` or risky `as unknown` patterns introduced since last review.

## Velocity Trajectory

### Rework Ratio Since Last Review: Healthy 14%

14 commits since last review:
- **10 feature/implementation** (71%): Phase 4c, loop detection, steering queue, truncation P1, env filtering, bench adapter
- **2 rework/fix** (14%): mode_change parentId fix, theme centralization
- **2 other** (14%): codex-rs research, backlog update

14% rework is healthy. The two rework commits are both focused and proportionate:
- `07d0a40` — 51 line fix for mode_change entries breaking session parentId chain (bug found via debug-viewer, fixed cleanly)
- `028917c` — theme.ts centralization (207 insertions, 106 deletions — planned refactor, not emergency)

### Code Growth: Controlled

| Metric | At 10f036c | At 8bae17a | Delta |
|--------|-----------|-----------|-------|
| Core source files | ~45 | 52 | +7 |
| Core source lines | ~6,500 | ~8,200 | +1,696 |
| Core test lines | ~3,500 | ~5,600 | +2,100 |
| Tests passing | 529 | 594 | +65 |
| expect() calls | 1,159 | 1,341 | +182 |

Test-to-production growth ratio: 2,100 test lines / 1,696 source lines = **1.24:1**. Tests grew faster than production code. Excellent.

### Zero Throwaway Work

0 deleted files in `packages/core/` since last review. Every line written survived.

## Forward Compatibility

### SessionManager Complexity: Watch Item

**Horizon**: Compounds over Phases 5+
**Current state**: 447 lines, 7 public methods, 8 private methods

SessionManager now handles 6 distinct responsibilities:
1. Session CRUD (create, resume, list)
2. Agent loop orchestration (run, proxyAgentLoop, runAgentLoopInner)
3. Compaction coordination (performCompaction, getPathEntries, findPreviousCompaction)
4. Steering/follow-up (steer, followUp, drainSteeringQueue)
5. Mode changes (appendModeChange)
6. Event proxying + persistence (handleEvent, appendMessageEntry, appendSteeringEntry)

The `runWithCompaction` → `proxyAgentLoop` → `runAgentLoopInner` call chain is 3 levels deep. Still manageable, but when L4 (approval) and L10 (multi-agent) add their concerns, this class risks becoming the "god object" that everything flows through.

**Not urgent now** — the code is clean and well-structured. But if you find yourself adding more methods to SessionManager, that's the signal to extract. Natural extraction points:
- Compaction logic → `CompactionManager` (takes entries + writer, returns compacted messages)
- Steering/follow-up → already has clear methods, could become a `SteeringQueue` collaborator

### Context Overflow Detection: Type Information Loss

**Horizon**: Becomes problem if error classification needs to be precise (Phase 5 multi-provider)
**Location**: `session/manager.ts:206-218`

When the inner agent loop catches a `ProviderError` with `errorType: "context_overflow"`, it serializes it via `toSerializableError()` which strips the `errorType` field. The outer SessionManager then reconstructs the error type by **string matching** on the message:

```typescript
const isContextOverflow =
  msg.includes("context") ||
  msg.includes("too many tokens") ||
  msg.includes("maximum") ||
  msg.includes("context_overflow");
```

This works today because Anthropic/OpenAI error messages happen to contain these strings. But it's fragile:
- A future provider might say "input exceeds limit" without using any of these keywords
- A non-English error message would bypass all patterns
- The strings "context" and "maximum" could match non-overflow errors

**Fix**: Either pass `errorType` through `SerializableError` (add optional `errorType?: string` field), or have the inner agent loop throw `ProviderError` directly instead of converting to `SerializableError` first. The latter is simpler since the error doesn't need to cross a serialization boundary here — it's caught in the same process.

### appendEntry O(n²) Pattern

**Horizon**: Noticeable for long sessions (100+ entries) in Phase 5+
**Location**: `session/persistence.ts:31-35`

```typescript
export async function appendEntry(sessionPath: string, entry: SessionEntry): Promise<void> {
  const file = Bun.file(sessionPath);
  const existing = await file.text();
  await Bun.write(sessionPath, `${existing}${JSON.stringify(entry)}\n`);
}
```

Every append reads the entire file and rewrites it. For a session with 200 entries averaging 2KB each, that's ~400KB read+write per entry, totaling ~80MB of I/O for the session. Bun supports `Bun.file().writer()` for efficient appending.

**Not blocking** — sessions rarely exceed 50-100 entries before compaction, and I/O is async. But worth fixing when touching persistence next.

### Provider Code Duplication

**Horizon**: Friction point when adding 3rd provider (Phase 5/MCP)
**Location**: `provider/anthropic.ts` vs `provider/openai.ts`

Duplicated verbatim:
- `isNetworkError()` function — identical in both files (5 lines)
- Error classification structure — same pattern (status code switch → ProviderError)
- Retry-after header parsing — same logic, slightly different API surface (Record vs Headers)

When a 3rd provider is added, this becomes 3 copies. A `classifyHttpError(status, message, headers)` shared helper would eliminate the duplication. Low urgency — 2 copies is manageable.

### Model Registry Staleness

**Horizon**: Cosmetic, but affects cost tracking accuracy
**Location**: `provider/models.ts`

KNOWN_MODELS contains 5 models. Missing newer Anthropic models (Opus 4, Claude Sonnet 4.5/4.6). The `resolveModel` fallback handles unknown models gracefully (infers provider from prefix, uses sensible defaults), so functionality is unaffected. But cost tracking returns 0 for any model not in the registry since `inputCostPer1M`/`outputCostPer1M` are undefined.

### Deferred Decisions Check

No deferred decisions block upcoming work:
- D015 `supportParallel` — deferred, not needed ✅
- D024 fuzzy edit match — deferred, not needed ✅
- L4 Approval (D027-D031) — deferred, workaround via tool filtering working ✅
- D055 command palette — deferred ✅
- D085 knowledge export/import — deferred ✅

## Priority Actions (Backlog Candidates)

### 1. Fix ARCHITECTURE.md AgentEvent count (Cosmetic)

**What**: Update line 43 ("15 tagged-union event types") and line 59 ("18 AgentEvent types") to reflect actual count of 20.
**Why**: Any session that reads ARCHITECTURE.md first will count wrong types. Takes 1 minute.

### 2. Update BACKLOG.md — steering queue is done

**What**: Mark "Add steering queue to agent loop" as done (commit a848844 implements it fully).
**Why**: Stale backlog creates confusion about what's actually pending.

### 3. Add `errorType` to SerializableError (Technical Debt)

**What**: Add optional `errorType?: string` to `SerializableError` in `agent/types.ts`. Pass it through in `toSerializableError()`. Use it in `runAgentLoopInner` instead of string matching.
**Why**: Eliminates fragile string matching for error classification. 5-line change. Prevents a real bug when a 3rd provider is added.
**Decision ref**: Extends D010 (error classification) and D086 (serializable errors).

### 4. Fix appendEntry to use true append (Optimization)

**What**: Replace `Bun.file().text() + Bun.write()` with `Bun.file().writer()` in `persistence.ts:appendEntry`.
**Why**: O(n²) → O(1) per append. Matters for long sessions.

### 5. Extract `isNetworkError` to shared provider util (DRY)

**What**: Move `isNetworkError()` to `provider/errors.ts`, import from both provider files.
**Why**: Eliminates verbatim duplication. Sets up clean extraction point for `classifyHttpError` when 3rd provider arrives.

### 6. Update model registry (Cosmetic)

**What**: Add current Anthropic models to KNOWN_MODELS for accurate cost tracking.
**Why**: `/cost` command shows $0.00 for unlisted models.

---

*Assessment by Claude Opus 4.6 at commit 8bae17a. Core-focused review per user request. Next assessment recommended after L4 or L9 implementation begins.*
