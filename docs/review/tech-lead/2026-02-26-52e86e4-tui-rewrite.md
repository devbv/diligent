# Tech Lead Review — TUI Rewrite Decision

**Date**: 2026-02-26
**Commit**: 52e86e4
**Focus**: "TUI가 너무 불안하다 — codex-rs 구조로 다시 만들어야 하나?"

---

## Sustainability Verdict

**YELLOW → actionable path exists.** 이전 리뷰(6823d94)에서 지적한 버그 4개가 모두 수정됐다. 그러나 사용자가 여전히 "컨트롤이 안된다"고 느끼는 이유는 개별 버그가 아니라 **렌더링 모델 자체**에 있다. inline differential rendering은 cursor position state가 한 번 틀리면 이후 모든 프레임이 오염되는 구조다. 이건 패치로 해결되는 버그가 아니다 — 패치할수록 edge case가 새로 나온다.

codex-rs의 진짜 교훈은 파일 구조가 아니라 **alternate screen + full redraw** 모델이다. 이 모델을 채택하면 현재 불안정성의 근본 원인이 제거된다.

---

## Structural Integrity

### 이전 리뷰 버그들: 모두 수정 확인
**Impact**: 해소됨

- `types.ts:41` CURSOR_MARKER → `"\x1b_diligent:c\x07"` ✓
- `chat-view.ts:46` MarkdownView를 items에 저장, render(width)로 호출 ✓
- `renderer.ts:270` `const totalRows = this.terminal.rows` ✓
- `app.ts:236` `this.renderer.setFocus(this.inputEditor)` ✓

### 불안정성의 실제 원인: 렌더링 모델
**Impact**: Compounds every render cycle

현재 `renderer.ts`의 `buildDiffOutput()`은 다음을 가정한다:
1. 이전 렌더 이후 터미널이 스크롤되지 않았다
2. `prevCursorRow`가 항상 정확하다
3. content shrink/grow가 clean하게 처리된다

이 세 가지 중 하나라도 틀리면 **이후 모든 렌더가 오염**된다. cursor가 잘못된 행에 위치하면 다음 render에서 "move up N lines"가 잘못된 위치로 이동하고, 그 다음 render에서 더 잘못되고, 자기강화 순환이 된다.

pi-agent는 이 방식을 수년에 걸쳐 다듬었다. 우리에겐 그 시간이 없다.

---

## Forward Compatibility

### codex-rs가 실제로 하는 것
**Horizon**: 지금 당장 참고 가능

`codex-rs/tui/src/tui.rs`를 보면:
- `EnterAlternateScreen` / `LeaveAlternateScreen` (crossterm)
- ratatui가 매 프레임 전체 화면을 그림 (differential 없음)
- cursor 위치는 항상 알고 있다 — alternate screen에서 clear 후 (0,0)이 기준

이 구조가 안정적인 이유: **prevCursorRow 같은 state가 없다.** 매 프레임 시작 시 cursor 위치가 deterministic하다.

TypeScript에서 "codex-rs 구조 카피"는 Rust 코드 이식이 아니라 이 **렌더링 철학** 채택이다.

### Component 레이어: 재사용 가능
**Horizon**: 변경 불필요

현재 `Component` interface (`render(width): string[]`), `Focusable`, `OverlayStack`, `app.ts` 전체 — 이것들은 alternate screen 모델에서도 그대로 동작한다. 렌더러만 바뀐다.

---

## Priority Actions

1. **renderer.ts를 alternate screen + full redraw로 교체** — inline differential 모델 전체 폐기. 새 모델: start 시 `\x1b[?1049h` (alternate screen 진입), 매 프레임 `\x1b[H\x1b[2J` (cursor home + clear) 후 전체 라인 출력, stop 시 `\x1b[?1049l` (복귀). `buildDiffOutput`, `previousLines`, `prevCursorRow` 전부 삭제. renderer.ts가 ~150줄로 줄어든다.

   **범위**: `renderer.ts` + `terminal.ts`만 수정. app.ts, chat-view.ts, input-editor.ts 등 모든 컴포넌트 변경 없음.

   **UX 트레이드오프**: TUI 종료 시 terminal history가 사라진다 (alternate screen 특성). codex-rs, opencode 모두 이 트레이드오프를 수용했다. 코딩 에이전트에서 터미널 스크롤백보다 UI 안정성이 더 중요하다.

2. **ink 도입은 현재 단계에서 오버엔지니어링** — ink는 React 컴포넌트 모델로 전체 컴포넌트 레이어를 다시 써야 한다. alternate screen renderer만 교체하면 같은 안정성을 얻으면서 2주 재작업이 2시간으로 줄어든다.

3. **ChatView 무한 성장 문제는 Phase 5 전에 처리** — alternate screen 전환 후 남는 구조적 문제. `items` 배열이 무한 성장하고 매 프레임 전체를 render한다. alternate screen에서는 terminal.rows 이상의 라인을 화면에 그릴 수 없으므로 자연스럽게 슬라이싱이 필요해진다. Phase 5 scroll 구현 전에 last-N-lines 슬라이싱 추가 권장.
